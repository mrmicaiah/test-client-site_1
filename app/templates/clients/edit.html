{% extends "base.html" %}
{% block title %}Edit {{ client.name }} - MiKlean{% endblock %}

{% block header %}
<div class="flex items-center">
    <a href="{{ url_for('clients.view_client', client_id=client.id) }}" class="mr-4 text-gray-900">‚Üê</a>
    <h1 class="text-2xl font-extrabold text-gray-900">Edit Client</h1>
</div>
{% endblock %}

{% block bottom_nav %}{% endblock %}

{% block content %}
<form method="POST" class="space-y-4">
    <div>
        <label for="name" class="block text-sm font-semibold text-gray-600 mb-2">Name *</label>
        <input type="text" id="name" name="name" required
            value="{{ client.name }}"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">
    </div>
    
    <div>
        <label for="phone" class="block text-sm font-semibold text-gray-600 mb-2">Phone *</label>
        <input type="tel" id="phone" name="phone" required
            value="{{ client.phone }}"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">
    </div>
    
    <!-- Address Section -->
    <div class="border-2 border-gray-200 rounded-xl p-4 space-y-4">
        <p class="text-sm font-semibold text-gray-600">Address *</p>
        
        <!-- Search Box -->
        <div class="relative">
            <input type="text" id="address_search" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none bg-yellow-light"
                placeholder="üîç Search for new address...">
            <p class="text-xs text-gray-500 mt-1">Or edit manually below</p>
        </div>
        
        <div>
            <label for="street1" class="block text-xs font-semibold text-gray-500 mb-1">Street Address</label>
            <input type="text" id="street1" name="street1" required
                value="{{ client.street1 or '' }}"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none"
                placeholder="123 Main St">
        </div>
        
        <div>
            <label for="street2" class="block text-xs font-semibold text-gray-500 mb-1">Apt, Suite, Unit (optional)</label>
            <input type="text" id="street2" name="street2"
                value="{{ client.street2 or '' }}"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none"
                placeholder="Apt 4B">
        </div>
        
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label for="city" class="block text-xs font-semibold text-gray-500 mb-1">City</label>
                <input type="text" id="city" name="city" required
                    value="{{ client.city or '' }}"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none"
                    placeholder="City">
            </div>
            <div>
                <label for="state" class="block text-xs font-semibold text-gray-500 mb-1">State</label>
                <select id="state" name="state" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">
                    <option value="">State</option>
                    {% set states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'] %}
                    {% for s in states %}
                    <option value="{{ s }}" {% if client.state == s %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="w-1/2">
            <label for="zip_code" class="block text-xs font-semibold text-gray-500 mb-1">ZIP Code</label>
            <input type="text" id="zip_code" name="zip_code" required
                value="{{ client.zip_code or '' }}"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none"
                placeholder="12345">
        </div>
    </div>
    
    <div>
        <label for="email" class="block text-sm font-semibold text-gray-600 mb-2">Email</label>
        <input type="email" id="email" name="email"
            value="{{ client.email or '' }}"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">
    </div>
    
    <div>
        <label for="notes" class="block text-sm font-semibold text-gray-600 mb-2">Notes</label>
        <textarea id="notes" name="notes" rows="3"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">{{ client.notes or '' }}</textarea>
    </div>
    
    <div>
        <label for="type" class="block text-sm font-semibold text-gray-600 mb-2">Status</label>
        <select id="type" name="type"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-primary focus:outline-none">
            <option value="prospect" {% if client.type == 'prospect' %}selected{% endif %}>Prospect</option>
            <option value="client" {% if client.type == 'client' %}selected{% endif %}>Client</option>
            <option value="inactive" {% if client.type == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>
    </div>
    
    <button type="submit" 
        class="w-full bg-yellow-primary text-gray-900 font-bold py-4 rounded-xl hover:bg-yellow-dark transition">
        Save Changes
    </button>
</form>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCLOXScYN0mjaerNSdgCQOkqY5YFK0BWt0&libraries=places&callback=initAutocomplete" async defer></script>
<script>
function initAutocomplete() {
    const searchInput = document.getElementById('address_search');
    
    const autocomplete = new google.maps.places.Autocomplete(searchInput, {
        types: ['address'],
        componentRestrictions: { country: 'us' },
        fields: ['address_components', 'formatted_address']
    });
    
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        
        if (!place.address_components) {
            return;
        }
        
        // Clear existing values
        document.getElementById('street1').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('zip_code').value = '';
        
        let streetNumber = '';
        let streetName = '';
        
        for (const component of place.address_components) {
            const type = component.types[0];
            
            switch (type) {
                case 'street_number':
                    streetNumber = component.long_name;
                    break;
                case 'route':
                    streetName = component.long_name;
                    break;
                case 'locality':
                    document.getElementById('city').value = component.long_name;
                    break;
                case 'administrative_area_level_1':
                    document.getElementById('state').value = component.short_name;
                    break;
                case 'postal_code':
                    document.getElementById('zip_code').value = component.long_name;
                    break;
            }
        }
        
        document.getElementById('street1').value = streetNumber + (streetNumber && streetName ? ' ' : '') + streetName;
        searchInput.value = '';
        document.getElementById('street2').focus();
    });
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });
}
</script>
<style>
.pac-container {
    border-radius: 12px;
    border: 2px solid #E5E5E5;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 4px;
    font-family: 'Nunito', sans-serif;
}
.pac-item {
    padding: 12px 16px;
    cursor: pointer;
    border-top: 1px solid #F0F0F0;
}
.pac-item:first-child {
    border-top: none;
}
.pac-item:hover {
    background-color: #FFECB3;
}
.pac-item-query {
    font-size: 14px;
    color: #1A1A1A;
}
.pac-matched {
    font-weight: 700;
}
.pac-icon {
    display: none;
}
</style>
{% endblock %}
