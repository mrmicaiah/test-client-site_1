{% extends "base.html" %}
{% block title %}Estimate - MiKlean{% endblock %}

{% block header %}
<div class="flex items-center justify-between">
    <div class="flex items-center">
        <a href="{{ url_for('clients.view_client', client_id=estimate.client_id) }}" class="mr-4 text-gray-900">←</a>
        <div>
            <h1 class="text-2xl font-extrabold text-gray-900">Estimate</h1>
            <p class="text-sm text-gray-700">for {{ estimate.clients.name }}</p>
        </div>
    </div>
    {% if estimate.status in ['draft', 'sent'] %}
    <a href="{{ url_for('estimates.edit_estimate', estimate_id=estimate.id) }}" class="text-gray-700">✏️</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- Status -->
<div class="mb-4">
    <span class="badge badge-{{ estimate.status }}">{{ estimate.status|capitalize }}</span>
    {% if estimate.sent_at %}
    <span class="text-sm text-gray-500 ml-2">Sent {{ estimate.sent_at[:10] }}</span>
    {% endif %}
    {% if estimate.accepted_at %}
    <span class="text-sm text-gray-500 ml-2">Accepted {{ estimate.accepted_at[:10] }}</span>
    {% endif %}
</div>

<!-- Estimate Details -->
<div class="card mb-4">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">SERVICE</p>
    <p class="text-gray-900 whitespace-pre-wrap mb-4">{{ estimate.description }}</p>
    
    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">PRICING</p>
    <p class="text-2xl font-bold text-gray-900">${{ "%.2f"|format(estimate.price_per_visit) }}<span class="text-base font-normal text-gray-600"> / visit</span></p>
    
    {% if monthly_rate and estimate.show_monthly_rate %}
    <p class="text-gray-600">${{ "%.2f"|format(monthly_rate) }} / month</p>
    {% endif %}
    
    <p class="text-sm text-gray-600 mt-2">{{ estimate.frequency|capitalize }}</p>
    
    {% if estimate.preferred_day or estimate.preferred_time %}
    <p class="text-sm text-gray-600 mt-1">
        {% if estimate.preferred_day %}{{ estimate.preferred_day|capitalize }}{% endif %}
        {% if estimate.preferred_day and estimate.preferred_time %}, {% endif %}
        {% if estimate.preferred_time %}{{ estimate.preferred_time }}{% endif %}
    </p>
    {% endif %}
</div>

<!-- Actions based on status -->
{% if estimate.status == 'draft' %}
<div class="space-y-2">
    <a href="{{ url_for('estimates.preview_estimate', estimate_id=estimate.id) }}" 
       class="block w-full text-center bg-yellow-primary text-gray-900 font-bold py-4 rounded-xl">
        Preview & Send
    </a>
    <form method="POST" action="{{ url_for('estimates.accept_estimate', estimate_id=estimate.id) }}">
        <button type="submit" class="w-full border-2 border-green-500 text-green-600 font-bold py-4 rounded-xl">
            ✓ Mark as Accepted
        </button>
    </form>
</div>

{% elif estimate.status == 'sent' %}
<div class="space-y-2">
    <form method="POST" action="{{ url_for('estimates.accept_estimate', estimate_id=estimate.id) }}">
        <button type="submit" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl">
            ✓ Mark as Accepted
        </button>
    </form>
    <a href="{{ url_for('estimates.send_estimate', estimate_id=estimate.id) }}" 
       class="block w-full text-center border-2 border-gray-300 text-gray-700 font-bold py-4 rounded-xl">
        Resend Estimate
    </a>
</div>
<p class="text-sm text-gray-500 text-center mt-2">Waiting for client to accept, or mark it accepted yourself</p>

{% elif estimate.status == 'accepted' %}
<div class="space-y-2">
    <a href="{{ url_for('visits.schedule_visits', client_id=estimate.client_id) }}" 
       class="block w-full text-center bg-yellow-primary text-gray-900 font-bold py-4 rounded-xl">
        Add to Schedule
    </a>
</div>
{% endif %}
{% endblock %}
