{% extends "base.html" %}
{% block title %}Schedule Visits - MiKlean{% endblock %}

{% block header %}
<div class="flex items-center">
    <a href="{{ url_for('clients.view_client', client_id=client.id) }}" class="mr-3 text-ink/60 hover:text-ink">
        <i data-lucide="x" class="w-6 h-6"></i>
    </a>
    <div>
        <h1 class="text-xl font-bold text-ink">Add to Schedule</h1>
        <p class="text-sm text-ink/60">{{ client.name }}</p>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}{% endblock %}

{% block content %}
<form method="POST" class="space-y-4">
    <!-- Schedule Type Selection -->
    <div class="card card-brand">
        <label class="block text-sm font-medium text-neutral-600 mb-3">What are you scheduling?</label>
        <div class="grid grid-cols-2 gap-3">
            <label class="relative">
                <input type="radio" name="frequency" value="one_time" class="peer sr-only" checked>
                <div class="p-4 text-center rounded-lg cursor-pointer border-b-3 border-neutral-200 bg-neutral-50 text-neutral-600 peer-checked:border-brand peer-checked:bg-brand/10 peer-checked:text-ink font-semibold transition-all">
                    <i data-lucide="calendar-check" class="w-6 h-6 mx-auto mb-2"></i>
                    <span class="text-sm">One-Time Visit</span>
                </div>
            </label>
            <label class="relative">
                <input type="radio" name="frequency" value="recurring" class="peer sr-only">
                <div class="p-4 text-center rounded-lg cursor-pointer border-b-3 border-neutral-200 bg-neutral-50 text-neutral-600 peer-checked:border-brand peer-checked:bg-brand/10 peer-checked:text-ink font-semibold transition-all">
                    <i data-lucide="repeat" class="w-6 h-6 mx-auto mb-2"></i>
                    <span class="text-sm">Recurring Schedule</span>
                </div>
            </label>
        </div>
    </div>
    
    <!-- Date/Time -->
    <div class="card">
        <div class="space-y-4">
            <div>
                <label for="start_date" class="block text-sm font-medium text-neutral-600 mb-1.5">
                    <span id="date_label">Visit Date</span> *
                </label>
                <input type="date" id="start_date" name="start_date" required class="input">
            </div>
            
            <div>
                <label for="preferred_time" class="block text-sm font-medium text-neutral-600 mb-1.5">Time (optional)</label>
                <input type="time" id="preferred_time" name="preferred_time" class="input">
            </div>
        </div>
    </div>
    
    <!-- Recurring Options (hidden by default) -->
    <div id="recurring_options" class="card hidden">
        <p class="text-sm font-semibold text-ink mb-3">Recurring Options</p>
        
        <div class="space-y-4">
            <div>
                <label for="recurring_frequency" class="block text-sm font-medium text-neutral-600 mb-1.5">How often?</label>
                <select id="recurring_frequency" name="recurring_frequency" class="input">
                    <option value="weekly" {% if estimate and estimate.frequency == 'weekly' %}selected{% endif %}>Every week</option>
                    <option value="biweekly" {% if estimate and estimate.frequency == 'biweekly' %}selected{% endif %}>Every 2 weeks</option>
                    <option value="monthly" {% if estimate and estimate.frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                </select>
            </div>
            
            <div>
                <label for="preferred_day" class="block text-sm font-medium text-neutral-600 mb-1.5">Preferred Day</label>
                <select id="preferred_day" name="preferred_day" class="input">
                    <option value="">Based on start date</option>
                    <option value="monday">Monday</option>
                    <option value="tuesday">Tuesday</option>
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday">Friday</option>
                    <option value="saturday">Saturday</option>
                    <option value="sunday">Sunday</option>
                </select>
            </div>
        </div>
        
        <div class="mt-4 p-3 bg-brand/10 rounded-lg">
            <p class="text-sm text-ink/70">
                <strong>Note:</strong> This creates visits for the next 8 weeks. As you complete visits, new ones are added automatically.
            </p>
        </div>
    </div>
    
    {% if estimate %}
    <div class="card">
        <p class="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-2">From Estimate</p>
        <div class="flex justify-between items-center">
            <span class="text-neutral-600">{{ estimate.frequency|replace('_', ' ')|title }} @ ${{ "%.2f"|format(estimate.price_per_visit) }}</span>
            <span class="badge badge-accepted">Accepted</span>
        </div>
    </div>
    {% endif %}
    
    <div class="space-y-3 pt-2">
        <button type="submit" class="btn-primary w-full">
            <span id="submit_text">Schedule Visit</span>
        </button>
        <a href="{{ url_for('clients.view_client', client_id=client.id) }}" class="btn-secondary w-full">Cancel</a>
    </div>
</form>

<script>
    const frequencyRadios = document.querySelectorAll('input[name="frequency"]');
    const recurringOptions = document.getElementById('recurring_options');
    const dateLabel = document.getElementById('date_label');
    const submitText = document.getElementById('submit_text');
    
    frequencyRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'recurring' && radio.checked) {
                recurringOptions.classList.remove('hidden');
                dateLabel.textContent = 'Start Date';
                submitText.textContent = 'Create Schedule';
            } else {
                recurringOptions.classList.add('hidden');
                dateLabel.textContent = 'Visit Date';
                submitText.textContent = 'Schedule Visit';
            }
        });
    });
    
    // Re-init Lucide icons after page load
    lucide.createIcons();
</script>
{% endblock %}
